<!DOCTYPE html>
<html>
<head>
	<title>ラボショップシステム</title>
	<meta charset="utf-8"/>

	<link rel="stylesheet" href="../css/style.css" type="text/css"/>
	<link rel="stylesheet" href="../css/github-markdown.css" type="text/css"/>

	<script type="text/javascript" src="../dwr/engine.js"></script>
	<script type="text/javascript" src="../dwr/util.js"></script>
	<script type="text/javascript" src="../dwr/interface/WebAdminAccountAggregate.js"></script>

	<script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="../js/jquery.serialize.js"></script>
	<script type="text/javascript" src="../js/jquery.cookie.js"></script>
	<script type="text/javascript" src="../js/labshop.js"></script>
	<script type="text/javascript" src="../js/labshop.util.js"></script>
	<script type="text/javascript" src="../js/labshop.account-aggregate.js"></script>

	<script type="text/javascript" src="script.js"></script>

	<script type="text/javascript">
	var TARGET_ITEM_ID;
	var TARGET_MEMBER_ID;
	var TARGET_MEBMER_NAME;

	$(function(){
		init();
	});

	function aborting(msg){
		alert(msg);
		location.href = "/";
	}

	function init(){
		var param = labshop.getUrlParameters();
		if( param.itemid == undefined ){
			TARGET_ITEM_ID = confirm("アイテムIDを入力して下さい");
		}else{
			TARGET_ITEM_ID = param.itemid;
		}
		if( TARGET_ITEM_ID == undefined ){
			aborting("アイテムIDが指定されていません");
		}



		labshop.getItemData(param.itemid, function(ret){
			if( ret.isErr ) aborting(ret.errMsg);

			$("#itemName").text("[" + ret.item.id + "] " + ret.item.name);
			$("#itemPrice").text(ret.item.price);
		});

		labshop.getClientSessionState(function(ret){
			if( ret.isOpened ){
				TARGET_MEMBER_ID = ret.session.memberId;
				TARGET_MEMBER_NAME = ret.session.memberName;
			}
			setAuthForm();
		});
	}

	function setAuthForm(){
		var wrap = $("#authFormWrap");
		wrap.empty();

		if( TARGET_MEMBER_ID == undefined ){
			var form = $("<form></form>");
			form.append(
				$("<table></table>").append(
					$("<tr></tr>").append(
						$("<td></td>").text("メンバーID")
					).append(
						$("<td></td>").append(
							$("<input></input>").attr("type", "text")
							.attr("name", "memberId")
							.attr("style", "font-size: x-large;")
						)
					)
				).append(
					$("<tr></tr>").append(
						$("<td></td>").text("パスワード")
					).append(
						$("<td></td>").append(
							$("<input></input>").attr("type", "text")
							.attr("name", "password")
							.attr("style", "font-size: x-large;")
						)
					)
				)
			);

			wrap.append(form);
		}
		else
		{
			wrap.append(
				$("<table></table>").append(
					$("<tr></tr>").append(
						$("<td></td>").text("購入者")
					).append(
						$("<td></td>").text(
						"[" + TARGET_MEMBER_ID + "] " + TARGET_MEMBER_NAME)
					)
				)
			).append(
				$("<p></p>").text("購入者を確認して下さい")
			).append(
				$("<a></a>").text("他のメンバーで購入")
					.attr("href", "javascript:void(0)")
					.attr("onclick", "otherMemberLoginButtonPressed()")
			);
		}
	}

	function registCallback(ret){
		if( ret.isErr ){
			$("#errMsg").text(ret.errMsg);
			setAuthForm();
			return;
		}

		if( ret.account != null ){
			location.href = "success.html?accountid=" + ret.account.id;
		}else{
			aborting("登録に失敗しました");
		}
	}

	function registButtonPressed(){
		if( TARGET_MEMBER_ID == undefined ){
			var input = $("#authForm").serializeJson();
			labshop.registAccountByPassword(
				input.memberId, input.password, TARGET_ITEM_ID, registCallback);
		}else{
			var sid = labshop.getClientSessionId();
			labshop.registAccountBySession(sid, TARGET_ITEM_ID, registCallback);
		}
	}

	function calcelButtonPressed(){
		aborting("キャンセルされました");
	}

	function otherMemberLoginButtonPressed(){
		TARGET_MEMBER_ID = undefined;
		setAuthForm();
	}




	</script>
</head>

<body>
	<div class="page_header"><div class="page_centering">
		<img src="../images/logo2.png"/>
	</div></div>

	<div class="page_centering markdown-body">

	<h1>購入画面</h1>
	<h4>購入商品</h4>

	<table class="text-large">
		<tr><td id="itemName">ひとくちサヴレ</td>
		<td id="itemPrice">60円</td></tr>
	</table>

	<h4>認証</h4>
	<blockquote id="errMsg" style="color: red;">
	</blockquote>

	<div id="authFormWrap" class="text-large">
	<table>
		<tr><th>メンバーID</th><td>
			<input type="text" style="font-size: x-large"/>
		</td></tr>
		<tr><th>パスワード</th><td>
			<input type="password" style="font-size: x-large"/>
		</td></tr>
	</table>
	</div>

	<div class="text-center">
		<button type="button" style="font-size: x-large"
			onclick="registButtonPressed()">購入する</button>
		<button type="button" style="font-size: x-large"
			onclick="cancelButtonPressed()">キャンセル</button>
	</div>



	</div>

	<div class="page_header text-center markdown-body">
	<i>igakilab labshop system</i></div>
</body>
</html>