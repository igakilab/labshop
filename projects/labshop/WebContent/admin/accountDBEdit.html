<!DOCTYPE html>
<html lang="ja">
  <head>
  	<title>ラボショップシステム</title>
  	<meta charset="utf-8"/>

	<link rel="stylesheet" href="../css/style.css" type="text/css"/>
	<link rel="stylesheet" href="../css/github-markdown.css" type="text/css"/>

	<script type="text/javascript" src="../dwr/engine.js"></script>
	<script type="text/javascript" src="../dwr/util.js"></script>
    <script type="text/javascript" src="../dwr/interface/WebSessionManager.js"></script>
    <script type="text/javascript" src="../dwr/interface/WebAdminDBEditor.js"></script>

	<script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="../js/jquery.serialize.js"></script>
    <script type="text/javascript" src="../js/jquery.cookie.js"></script>
    <script type="text/javascript" src="../js/labshop.js"></script>
    <script type="text/javascript" src="../js/labshop.util.js"></script>
    <script type="text/javascript" src="../js/labshop.session.js"></script>
    <script type="text/javascript" src="../js/labshop.admin.dbedit.js"></script>

    <script type="text/javascript">

    $(function(){
    	initAccountDataForm();
    	updateAccountList();
    });

    function initAccountDataForm(accountId){
    	if( accountId !== undefined ){
    		var sid = labshop.getClientSessionId();
    		labshop.getItemData(sid, accountId, initItemDataFormCallback);
    	}
    	initAccountDataFormCallback();
    }

	function initAccountDataFormCallback(ret){
		var input_id = $("<input></input>")
			.attr("type", "text")
			.attr("name", "id");
		var input_memberId= $("<input></input>")
			.attr("type", "text")
			.attr("name", "memberId");
		var input_itemId = $("<input></input>")
			.attr("type", "text")
			.attr("name", "itemId");
		var input_sellPrice = $("<input></input>")
			.attr("type", "text")
			.attr("name", "sellPrice");
		var button_submit = $("<button></button>")
			.attr("type", "button")
			.attr("onclick", "addButtonPressed()")
			.text("追加");

		if( ret !== undefined ){
			if( ret.isErr ){
				alert(ret.errMsg);
				return;
			}

			input_id.val(ret.data.id)
				.attr("readonly", "readonly");
			input_memberId.val(ret.data.memberId);
			input_itemId.val(ret.data.itemId);
			input_sellPrice.val(ret.data.sellPrice);
			button_submit.attr("onclick", "updateButtonPressed()")
				.text("更新");
		}

		$("#itemDataForm_id_cell").empty()
			.append(input_id);
		$("#itemDataForm_memberId_cell").empty()
			.append(input_memberId);
		$("#itemDataForm_itemId_cell").empty()
			.append(input_itemId);
		$("#itemDataForm_sellPrice_cell").empty()
		.append(input_sellPrice);
		$("#itemDataForm_submit_wrap").empty()
			.append(button_submit);
    }

	function updateAccountList(){
		var sid = labshop.getClientSessionId();
		labshop.getAccountList(sid, updateItemListCallback);
	}

	function updateAccountListCallback(ret){
		if( ret.isErr ){
			alert(ret.errMsg + ": " + labshop.getClientSessionId());
			return;
		}

		var accountList = ret.list;
		var table = $("#accountListTable");

		table.empty();
		table.append(labshop.createLabelsRow(
			["ID", "メンバーID", "アイテムID", "購入価格", "操作"]));

		for(var i=0; i<accountList.length; i++){
			var btn_edit = $("<button></button>").text("編集")
				.attr("type", "button")
				.attr("onclick", "editButtonPressed(" + accountList[i].id + ")")
			var btn_remove = $("<button></button>").text("削除")
				.attr("type", "button")
				.attr("onclick", "removeButtonPressed(" + accountList[i].id + ")");

			table.append(
				$("<tr></tr>").append(
					$("<td></td>").text(accountList[i].id)
				).append(
					$("<td></td>").text(accountList[i].name)
				).append(
					$("<td></td>").text(accountList[i].price)
				).append(
					$("<td></td>").append(btn_edit)
						.append(btn_remove)
				)
			);
		}
	}

	function createButtonPressed(){
		initAccountDataForm();
	}

	function addButtonPressed(){
		var input = $("#accountDataForm").serializeJson();
		var sid = labshop.getClientSessionId();
		if( $("#chkbox_autoIdRegist").prop("checked") ){
			labshop.registAccount(sid, input, editExcuteCallback);
		}else{
			if( confirm("idは自動付番されません。よろしいですか？") ){
				labshop.editAccountDB(sid, "insert", input, editExcuteCallback);
			}
		}
	}

	function updateButtonPressed(){
		var input = $("#accountDataForm").serializeJson();
		var sid = labshop.getClientSessionId();
		labshop.editAccountDB(sid, "update", input, editExcuteCallback);
	}

	function editButtonPressed(accountId){
		initAccountDataForm(accountId);
	}

	function removeButtonPressed(accountId){
		if( !confirm("ID番号[" + accountId + "]のデータを削除してもよろしいですか？") ){
			return;
		}

		var sid = labshop.getClientSessionId();
		labshop.editAccountDB(sid, "remove", {id: accountId}, editExcuteCallback);
	}

	function editExcuteCallback(ret){
		if( ret.isErr ){ alert(ret.errMsg); return;}
		if( !ret.isSuccess ){ alert("処理が正常に終了しませんでした"); }
		updateAccountList();
	}
    </script>

</head>
<body>
	<div class="page_header">
		<div class="page_centering">
			<img src="../images/logo2.png"/>
		</div>
	</div>

	<div class="markdown-body page_centering">
		<h1>account database editor</h1>


		<form id="accountDataForm">
		<table>
			<tr><th>メンバーID</th>
			<th>アイテムID</th>
			<th>購入価格</th>
			<th>登録</th></tr>
			<tr>
				<td><input id="accountDataForm_memberId" type="text" name="memberId"/></td>
				<td><input id="accountDataForm_itemId" type="text" name="itemId"/></td>
				<td><input id="accountDataForm_sellPrice" type="text" name="sellPrice"/></td>
				<td><button type="button" onclick="registButtonPressed()">登録</button>
			</tr>
		</table>
		</form>

		<h3>伝票リスト</h3>
		<table id="accountListTable"></table>

	</div>


  </body>
</html>